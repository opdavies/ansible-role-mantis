---
- name: Download Mantis.
  get_url:
    url: "http://sourceforge.net/projects/mantisbt/files/mantis-stable/1.2.19/mantisbt-{{ mantis_version }}.{{ mantis_file_extension }}/download"
    dest: "{{ mantis_tmp }}"

- name: Create directory for Mantis.
  file:
    path: "{{ mantis_path }}"
    state: directory

- name: Extract Mantis.
  unarchive:
    src: "{{ mantis_tmp }}"
    dest: "{{ mantis_path }}"
    copy: no
    mode: 0755
    owner: root
    group: root

- name: Install packages.
  apt:
    name: "{{ item }}"
    state: installed
  with_items:
    - apache2
    - mysql-server
    - php5
    - php5-mysql

- name: Start services.
  service:
    name: "{{ item }}"
    state: running
    enabled: true
  with_items:
    - apache2
    - mysql

- name: Create Mantis vhost.
  template:
    src: vhost.j2
    dest: /etc/apache2/sites-enabled/mantis.conf
  notify: restart apache

- name: Install python-mysqldb
  apt:
    name: python-mysqldb
  when: mantis_db_name is defined

- name: Create Mantis database.
  mysql_db:
    name: "{{ mantis_db_name }}"
    state: present
  when: mantis_db_name is defined

- name: Create Mantis database user.
  mysql_user:
    name: "{{ mantis_db_user }}"
    password: "{{ mantis_db_pass }}"
    state: present
    priv: "{{ mantis_db_name }}.*:ALL"
  when: mantis_db_name is defined

- name: Copy config_inc.php
  template:
    src: config_inc.php.j2
    dest: "{{ mantis_full_path }}/config_inc.php"
    mode: 0755
    owner: root
    group: root
